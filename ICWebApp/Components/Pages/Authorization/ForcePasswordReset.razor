@page "/ForcePasswordReset/{resetToken}"
@using ICWebApp.Application.Interface.Provider
@using ICWebApp.Application.Interface.Services
@using ICWebApp.Components.Components.Authorization;

@if (tokenValid && user != null)
{
    <div class="container">
        <div class="row py-5">
            <div class="col-12">
                <ChangePasswordComponent User="user" IsForceReset="@true"></ChangePasswordComponent>
            </div>
        </div>
    </div>
}
else if (tokenValid && municipalUser != null)
{
    <div class="container">
        <div class="row py-5">
            <div class="col-12">
                <MunicipalChangePasswordComponent User="municipalUser" IsForceReset="@true"></MunicipalChangePasswordComponent>
            </div>
        </div>
    </div>
}
else
{
    
}

@code {
    [Parameter] public string resetToken { get; set; }
    [Inject] ITEXTProvider TextProvider { get; set; }
    [Inject] IAUTHProvider AuthProvider { get; set; }
    [Inject] IBusyIndicatorService BusyIndicatorService { get; set; }
    [Inject] ISessionWrapper SessionWrapper { get; set; }
    [Inject] IBreadCrumbService BreadCrumbService { get; set; }

    private AUTH_Users? user;
    private AUTH_Municipal_Users? municipalUser;
    private bool tokenValid = false;

    protected override async Task OnInitializedAsync()
    {
        BreadCrumbService.ClearBreadCrumb();
        BreadCrumbService.ShowBreadCrumb = false;

        Guid resetTokenGuid = Guid.Empty;
        Guid.TryParse(resetToken, out resetTokenGuid);
        if (resetTokenGuid != Guid.Empty)
        {
            user = await AuthProvider.GetUserByForcePasswordResetToken(resetTokenGuid);
            if (user != null && user.ForcePasswordReset)
            {
                municipalUser = null;
                if (user.ForcePwResetTokenExpirationData > DateTime.Now)
                {
                    tokenValid = true;
                    SessionWrapper.PageTitle = TextProvider.Get("FORCE_PASSWORD_RESET_MESSAGE");
                    SessionWrapper.PageDescription = null;
                }
                else
                {
                    SessionWrapper.PageTitle = TextProvider.Get("FORCE_PASSWORD_RESET_TOKEN_EXPIRED");
                    SessionWrapper.PageDescription = null;
                }
            }
            else
            {
                municipalUser = await AuthProvider.GetMunicipalUserByForcePasswordResetToken(resetTokenGuid);
                if (municipalUser != null && municipalUser.ForcePasswordReset)
                {
                    if (municipalUser.ForcePwResetTokenExpirationData > DateTime.Now)
                    {
                        tokenValid = true;
                        SessionWrapper.PageTitle = TextProvider.Get("FORCE_PASSWORD_RESET_MESSAGE");
                        SessionWrapper.PageDescription = null;
                    }
                    else
                    {
                        SessionWrapper.PageTitle = TextProvider.Get("FORCE_PASSWORD_RESET_TOKEN_EXPIRED");
                        SessionWrapper.PageDescription = null;
                    }
                }
                else
                {
                    SessionWrapper.PageTitle = TextProvider.Get("FORCE_PASSWORD_RESET_INVALID");
                    SessionWrapper.PageDescription = null;
                }
            }
        }
        else
        {
            SessionWrapper.PageTitle = TextProvider.Get("FORCE_PASSWORD_RESET_INVALID");
            SessionWrapper.PageDescription = null;
        }
        BusyIndicatorService.IsBusy = false;
    }
}