@page "/Hp/Search"
@page "/Hp/Search/{SearchText}"
@using ICWebApp.Domain.Models.Searchbar

@layout FrontendLayout

<div class="container">
    <div role="search" id="search-form" method="get" class="search-form">
        <div class="form-group-bsi cmp-input-search-button mt-2 mb-4 mb-lg-50">
            <div class="input-group">
                <div class="input-group-prepend">
                    <div class="input-group-text">
                        <svg class="icon icon-md">
                            <use href="css/bootstrap-italia/svg/sprites.svg#it-search"></use>
                        </svg>
                    </div>
                </div>
                <input type="search" @bind-value="InputText" class="form-control-bsi" id="search-input" name="s" data-focus-mouse="false">
            </div>
            <button class="btn btn-primary" @onclick="SearchData">
                <span class="">@TextProvider.Get("FORMS_FRONTEND_SEARCH_BUTTON")</span>
            </button>
        </div>
        <div class="row justify-content-center">
            <div class="col-lg-3 d-none d-lg-block scroll-filter-wrapper">
                <h2 class="visually-hidden" id="filter">@TextProvider.Get("FORMS_FRONTEND_SEARCH_APPLICABLE_FILTER")</h2>
                <fieldset>
                    <EditForm Model="FilterOrganiations">
                    <legend class="h6 text-uppercase category-list__title">@TextProvider.Get("FORMS_FRONTEND_SEARCH_TYPES")</legend>
                        <div class="categoy-list pb-4">
                        <ul>
                            <li>
                                <div class="form-check">
                                    <div class="checkbox-body border-light py-3">
                                        <InputCheckbox @bind-Value="@FilterOrganiations" id="@TextProvider.Get("FORMS_FRONTEND_SEARCH_FILTER_ORGANISATIONS")"></InputCheckbox>
                                        <label for="@TextProvider.Get("FORMS_FRONTEND_SEARCH_FILTER_ORGANISATIONS")" class="subtitle-small_semi-bold mb-0 category-list__list">
                                            @TextProvider.Get("FORMS_FRONTEND_SEARCH_FILTER_ORGANISATIONS")
                                        </label>
                                    </div>
                                </div>
                            </li>
                            <li>
                                <div class="form-check">
                                    <div class="checkbox-body border-light py-3">
                                        <InputCheckbox @bind-Value="@FilterEvents" id="@TextProvider.Get("FORMS_FRONTEND_SEARCH_FILTER_EVENTS")"></InputCheckbox>
                                        <label for="@TextProvider.Get("FORMS_FRONTEND_SEARCH_FILTER_EVENTS")" class="subtitle-small_semi-bold mb-0 category-list__list">
                                            @TextProvider.Get("FORMS_FRONTEND_SEARCH_FILTER_EVENTS")
                                        </label>
                                    </div>
                                </div>
                            </li>
                            <li>
                                <div class="form-check">
                                        <div class="checkbox-body border-light py-3">
                                            <InputCheckbox @bind-Value="@FilterVenues" id="@TextProvider.Get("FORMS_FRONTEND_SEARCH_FILTER_VENUES")"></InputCheckbox>
                                        <label for="@TextProvider.Get("FORMS_FRONTEND_SEARCH_FILTER_VENUES")" class="subtitle-small_semi-bold mb-0 category-list__list">
                                            @TextProvider.Get("FORMS_FRONTEND_SEARCH_FILTER_VENUES")
                                        </label>
                                    </div>
                                </div>
                            </li>
                            <li>
                                <div class="form-check">
                                        <div class="checkbox-body border-light py-3">
                                        <InputCheckbox @bind-Value="@FilterDocuments" id="@TextProvider.Get("FORMS_FRONTEND_SEARCH_FILTER_DOCUMENTS")"></InputCheckbox>
                                        <label for="@TextProvider.Get("FORMS_FRONTEND_SEARCH_FILTER_DOCUMENTS")" class="subtitle-small_semi-bold mb-0 category-list__list">
                                            @TextProvider.Get("FORMS_FRONTEND_SEARCH_FILTER_DOCUMENTS")
                                        </label>
                                    </div>
                                </div>
                            </li>
                            <li>
                                <div class="form-check">
                                    <div class="checkbox-body border-light py-3">
                                        <InputCheckbox @bind-Value="@FilterNews" id="@TextProvider.Get("FORMS_FRONTEND_SEARCH_FILTER_NEWS")"></InputCheckbox>
                                        <label for="@TextProvider.Get("FORMS_FRONTEND_SEARCH_FILTER_NEWS")" class="subtitle-small_semi-bold mb-0 category-list__list">
                                            @TextProvider.Get("FORMS_FRONTEND_SEARCH_FILTER_NEWS")
                                        </label>
                                    </div>
                                </div>
                            </li>
                            <li>
                                <div class="form-check">
                                    <div class="checkbox-body border-light py-3">
                                        <InputCheckbox @bind-Value="@FilterServices" id="@TextProvider.Get("FORMS_FRONTEND_SEARCH_FILTER_SERVICES")"></InputCheckbox>
                                        <label for="@TextProvider.Get("FORMS_FRONTEND_SEARCH_FILTER_SERVICES")" class="subtitle-small_semi-bold mb-0 category-list__list">
                                            @TextProvider.Get("FORMS_FRONTEND_SEARCH_FILTER_SERVICES")
                                        </label>
                                    </div>
                                </div>
                            </li>
                            <li>
                                <div class="form-check">
                                    <div class="checkbox-body border-light py-3">
                                        <InputCheckbox @bind-Value="@FilterPeople" id="@TextProvider.Get("FORMS_FRONTEND_SEARCH_FILTER_PEOPLE")"></InputCheckbox>
                                        <label for="@TextProvider.Get("FORMS_FRONTEND_SEARCH_FILTER_PEOPLE")" class="subtitle-small_semi-bold mb-0 category-list__list">
                                            @TextProvider.Get("FORMS_FRONTEND_SEARCH_FILTER_PEOPLE")
                                        </label>
                                    </div>
                                </div>
                            </li>
                        </ul>
                    </div>
                    </EditForm>
                </fieldset>
                @if (Themes != null && Themes.Any())
                {
                    <fieldset>
                        <EditForm Model="FilterPeople">
                        <legend class="h6 text-uppercase category-list__title">@TextProvider.Get("FORMS_FRONTEND_SEARCH_THEMES")</legend>
                            <div class="categoy-list pb-4">
                                <ul>
                                    @foreach(var t in Themes.OrderBy(p => p.Title).ToList())
                                    {
                                        string id = "theme_" + t.Title;

                                        <li>
                                            <div class="form-check">
                                                <div class="checkbox-body border-light py-3">
                                                    <InputCheckbox id="@id" @bind-Value="t.Checked"></InputCheckbox>
                                                    <label for="@id" class="subtitle-small_semi-bold mb-0 category-list__list">
                                                        @t.Title
                                                    </label>
                                                </div>
                                            </div>
                                        </li>
                                    }
                                </ul>
                            </div>
                        </EditForm>
                    </fieldset>
                }
            </div>
            <div class="col-lg-8 offset-lg-1">
                <div class="d-flex justify-content-between align-items-center border-bottom border-light pb-3 mb-2">
                    @if (SearchItems != null)
                    {
                        <span class="search-results">                                                
                            <strong>@SearchItems.Count()</strong> @TextProvider.Get("FORMS_FRONTEND_SEARCH_RESULTS")
                        </span>
                    }
                    else
                    {
                        <span class="search-results">
                            <strong>0</strong> @TextProvider.Get("FORMS_FRONTEND_SEARCH_RESULTS")
                        </span>
                    }
                    <button type="button" data-bs-toggle="modal" data-bs-target="#modal-categories" class="btn p-0 pe-2 d-lg-none">
                        <span class="rounded-icon">
                            <svg class="icon icon-primary icon-xs mb-1" aria-hidden="true">
                                <use href="css/bootstrap-italia/svg/sprites.svg#it-funnel"></use>
                            </svg>
                        </span>
                        <span class="t-primary title-xsmall-semi-bold ms-1">
                            @TextProvider.Get("FORMS_FRONTEND_SEARCH_BUTTON")
                        </span>
                    </button>
                    <button type="button" data-bs-toggle="modal" data-bs-target="#" class="btn p-0 pe-2 d-none d-lg-block">
                        <span class="title-xsmall-semi-bold ms-1" @onclick="RemoveFilter">@TextProvider.Get("FORMS_FRONTEND_SEARCH_CLEAR_ALL_FILTER")</span>
                    </button>
                </div>
                <div class="container p-0">
                    <div class="row flex-column-reverse flex-lg-row">
                        <div class="col-12 pt-3">                            
                            @if (SearchItems != null && SearchItems.Any())
                            {
                                var showItems = new List<SearchbarItem>();

                                if (FilterOrganiations || FilterEvents || FilterVenues || FilterDocuments || FilterNews || FilterServices || FilterPeople)
                                {
                                    if (FilterOrganiations)
                                    {
                                        showItems.AddRange(SearchItems.Where(p => p.ItemType == SearchBarItemType.Organiations).ToList());
                                    }
                                    if (FilterEvents)
                                    {
                                        showItems.AddRange(SearchItems.Where(p => p.ItemType == SearchBarItemType.Events).ToList());
                                    }
                                    if (FilterVenues)
                                    {
                                        showItems.AddRange(SearchItems.Where(p => p.ItemType == SearchBarItemType.Venues).ToList());
                                    }
                                    if (FilterDocuments)
                                    {
                                        showItems.AddRange(SearchItems.Where(p => p.ItemType == SearchBarItemType.Documents).ToList());
                                    }
                                    if (FilterNews)
                                    {
                                        showItems.AddRange(SearchItems.Where(p => p.ItemType == SearchBarItemType.News).ToList());
                                    }
                                    if (FilterServices)
                                    {
                                        showItems.AddRange(SearchItems.Where(p => p.ItemType == SearchBarItemType.Services).ToList());
                                    }
                                    if (FilterPeople)
                                    {
                                        showItems.AddRange(SearchItems.Where(p => p.ItemType == SearchBarItemType.People).ToList());
                                    }
                                }
                                else
                                {
                                    showItems = SearchItems;
                                }

                                if(Themes != null && Themes.Where(p => p.Checked == true).Any())
                                {
                                    foreach(var t in Themes)
                                    {
                                        showItems = showItems.Where(p => (p.Themes == null || p.Themes.Contains(t.Title))).ToList();
                                    }
                                }

                                showItems = showItems.Where(p => InputText == null || (p.Title != null && p.Title.ToLower().Contains(InputText)) ||
                                                                (p.SubTitle != null && p.SubTitle.ToLower().Contains(InputText))
                                                           ).ToList();

                                <div id="load-more">
                                    @foreach (var item in showItems.OrderBy(p => p.ItemType).ThenBy(p => p.Title).Take(MaxCount).ToList())
                                    {
                                        <div class="cmp-card-latest-messages mb-3 mb-30" data-bs-toggle="modal" data-bs-target="#">
                                            <div class="card shadow-sm px-4 pt-4 pb-4 rounded">
                                                @if (!string.IsNullOrEmpty(item.SubTitleUrl))
                                                {
                                                    <div class="card-header border-0 p-0">
                                                        <a class="text-decoration-none title-xsmall-bold mb-2 category text-uppercase" @onclick="@(() => NavigateTo(item.SubTitleUrl))">
                                                            @item.SubTitle
                                                        </a>
                                                    </div>
                                                }
                                                <div class="card-body p-0 my-2">
                                                    <h3 class="green-title-big t-primary mb-8">
                                                        @if (!string.IsNullOrEmpty(item.Url))
                                                        {
                                                            <a class="text-decoration-none" @onclick="@(() => NavigateTo(item.Url))" data-element="service-link">@item.Title</a>
                                                        }
                                                        else
                                                        {
                                                            <span class="text-decoration-none" data-element="service-link">@item.Title</span>
                                                        }
                                                    </h3>
                                                    @if (!StringHelper.MarkupStringIsNullOrWhiteSpace(item.ShortText))
                                                    {
                                                        <p class="text-paragraph">
                                                            @((MarkupString)item.ShortText)
                                                        </p>
                                                    }
                                                </div>
                                            </div>
                                        </div>
                                    }
                                </div>

                                @if (showItems != null && MaxCount < showItems.Count())
                                {
                                    <div class="d-flex justify-content-center mt-4" id="load-more-btn">
                                        <button type="button" @onclick="ShowMore" class="btn btn-outline-primary pt-15 pb-15 pl-90 pr-90 mb-30 mb-lg-50 full-mb text-button">
                                            <span class="">@TextProvider.Get("FORMS_FRONTEND_SEARCH_SHOW_MORE")</span>
                                        </button>
                                    </div>
                                }
                                else
                                {
                                    <p class="text-center text-paragraph-regular-medium mt-4 mb-0" id="no-more-results">
                                        @TextProvider.Get("FORMS_FRONTEND_SEARCH_NOTHING_MORE")
                                    </p>
                                }
                            }
                            else
                            {
                                <p class="text-center text-paragraph-regular-medium mt-4 mb-0" id="no-more-results">
                                    @TextProvider.Get("FORMS_FRONTEND_SEARCH_NOTHING_MORE")
                                </p>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>